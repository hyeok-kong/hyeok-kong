### 카프카 컨슈머
#### 멀티 스레드 컨슈머
##### 멀티 워커 스레드 전략
- 데이터 처리를 멀티 스레드로 하는 경우
	- 단일 컨슈머가 poll()로 가져온 데이터를 멀티 워커 스레드로 처리
- **속도**에 확실한 이점이 있음
	- 데이터 처리가 끝나지 않았음에도 불구하고 커밋을 함 (오토커밋 시)
		- 리밸런싱, 컨슈머 장애 시 데이터 유실 발생 가능
	- 레코드 처리의 역전 현상 발생
		- 데이터를 순서대로 가져오지만, 처리 완료 시점은 순서대로가 아닐 수 있음
- 중복이나 순서 역전이 발생해도 되며, 매우 빠른 처리가 필요할 경우 사용
##### 멀티 스레드 전략
- 컨슈머 스레드 개수를 늘리는 경우
- 컨슈머가 파티션보다 많아지면 유휴 컨슈머가 생김
	- 이건 리소스만 차지하고 데이터 처리는 안함
#### 컨슈머 랙
- 최신 오프셋과 컨슈머 오프셋 간의 차이
	- 데이터 생성이 사용보다 빠르다면 컨슈머 랙이 증가함
##### 컨슈머 랙 확인 방법
###### 카프카 명령어 사용
>kafka-consuer-groups.sh
- 일회성으로 확인할 수 있음
- 지속적으로 기록하고 모니터링 하기는 힘들기 때문에 테스트용 카프카에서 주로 사용
###### 컨슈머 metrics() 사용
> KafkaConsumer 인스턴스의 metrics() 메서드
- 3가지 단점 존재
	1. 컨슈머가 동작할 경우에만 확인 가능
	2. 자기 자신의 정보만 수집할 수 있음
		- 컨슈머 어플리케이션이 여러 개 있을 시 중복 코드를 작성해야 함
	3. 카프카 서드파티 애플리케이션의 컨슈머 랙 모니터링 불가
###### 외부 모니터링 툴을 사용하여 컨슈머 랙 조회
- **카프카 버로우**
	- 다수의 카프카 클러스터를 동시에 연결하여 확인 가능
	- 임계치 표시가 아닌 **슬라이딩 윈도우 계산**을 통해 컨슈머 상태 표현
		- 이를 컨슈머 랙 평가 라고 함
			- 파티션의 상태를 OK, STALLED, STOPPED 로 표현
			- 컨슈머의 상태를 OK, WARNING, ERROR 로 표현
				1. 컨슈머 랙이 지속적으로 증가하는 경우
					- 파티션 = OK / 컨슈머 = WARNING
				2. 컨슈머 오프셋이 멈추며 컨슈머 랙이 급격하게 증가할 경우
					- 파티션 = STALLED / 컨슈머 = ERROR
